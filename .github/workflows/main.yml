name: BMI Calculator

on:
  push:
    branches:
      - main
jobs:
  calculating:
    runs-on: ubuntu-latest
    steps:

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Dependencies
        run: npm install

      - name: Test the CalculateBMI function
        run: npm test

      - name: Setup ssh keys
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy to EC2
        run: | 
          # SSH to EC2 instance (no need to specify -i because ssh-agent is managing the key)
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_PUBLIC_IP }} << 'EOF'
          # Installiere NVM, falls es nicht bereits installiert ist
          if ! command -v nvm &> /dev/null; then
            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash
          fi

          # Lade NVM und installiere die Node.js-Version
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # NVM laden
          nvm install 18  # Installiere Node.js 18 über NVM
          nvm use 18  # Verwende Node.js Version 18

          # Überprüfe, ob Node.js und npm verfügbar sind
          node -v  # Node.js-Version anzeigen
          npm -v   # npm-Version anzeigen

          # Überprüfe, ob das Verzeichnis existiert, bevor es geklont wird
          if [ ! -d "/home/ubuntu/bmi-calculator" ]; then
            mkdir -p /home/ubuntu/bmi-calculator
          fi
          cd /home/ubuntu/bmi-calculator

          # Führe nur git clone aus, wenn das Verzeichnis leer ist
          if [ -z "$(ls -A .)" ]; then
            git clone https://github.com/${{ github.repository }}.git .
          else
            git pull origin main  # Falls das Repo existiert, aktualisiere es
          fi

          npm install

          # Installiere pm2, falls es nicht installiert ist
          if ! command -v pm2 &> /dev/null; then
            npm install -g pm2
          fi

          # Starte den Node.js-Server mit pm2
          pm2 start server.js --name bmi-calculator --no-daemon

          EOF
